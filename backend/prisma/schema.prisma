generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MODERATOR
  GENEL_BASKAN
  GENEL_BASKAN_YRD
  GENEL_SEKRETER
  IL_BASKANI
  ILCE_TEMSILCISI
  ISYERI_TEMSILCISI
  BAYI_YETKILISI
  UYE
}

model User {
  id           String @id @default(cuid())
  email        String @unique
  passwordHash String
  firstName    String
  lastName     String

  isActive  Boolean   @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  scopes     UserScope[]
  customRoles CustomRole[] @relation("UserCustomRoles")
  
  // ðŸ”¹ Ãœye iliÅŸkileri
  createdMembers  Member[] @relation("MemberCreatedBy")
  approvedMembers Member[] @relation("MemberApprovedBy")
  cancelledMembers Member[] @relation("MemberCancelledBy")
}

enum MemberStatus {
  PENDING // baÅŸvuru yapÄ±ldÄ±, onay bekliyor
  ACTIVE // aktif Ã¼ye
  INACTIVE // pasif
  RESIGNED // istifa etmiÅŸ
  EXPELLED // ihraÃ§ edilmiÅŸ
  REJECTED // baÅŸvuru reddedildi
}

enum MemberSource {
  DIRECT // panelden direkt baÅŸvuru
  WORKPLACE // iÅŸyeri temsilcisi Ã¼zerinden
  DEALER // bayi Ã¼zerinden
  OTHER
}

enum DuesPeriod {
  MONTHLY
  YEARLY
}

model Member {
  id         String       @id @default(cuid())
  firstName  String
  lastName   String
  nationalId String?      @unique
  phone      String?
  email      String?
  status     MemberStatus @default(PENDING)
  source     MemberSource @default(DIRECT)

  // BÃ¶lge iliÅŸkileri vs...
  provinceId  String?
  districtId  String?
  workplaceId String?
  dealerId    String?

  province  Province?  @relation(fields: [provinceId], references: [id])
  district  District?  @relation(fields: [districtId], references: [id])
  workplace Workplace? @relation(fields: [workplaceId], references: [id])
  dealer    Dealer?    @relation(fields: [dealerId], references: [id])

  createdByUserId  String?
  approvedByUserId String?
  approvedAt       DateTime?

  // ðŸ”¹ KullanÄ±cÄ± iliÅŸkileri
  createdBy  User? @relation("MemberCreatedBy", fields: [createdByUserId], references: [id])
  approvedBy User? @relation("MemberApprovedBy", fields: [approvedByUserId], references: [id])
  cancelledBy User? @relation("MemberCancelledBy", fields: [cancelledByUserId], references: [id])

  // ðŸ”¹ Ãœyelik iptal bilgisi
  cancellationReason String? // ÃœyeliÄŸin iptal edilme nedeni
  cancelledByUserId   String? // ÃœyeliÄŸi iptal eden kullanÄ±cÄ±
  cancelledAt         DateTime? // ÃœyeliÄŸin iptal edildiÄŸi tarih

  // ðŸ”¹ Ã–nceki iptal edilmiÅŸ Ã¼ye bilgisi (yeniden Ã¼ye olanlar iÃ§in)
  previousCancelledMemberId String? // Daha Ã¶nce iptal edilmiÅŸ Ã¼yenin ID'si
  previousCancelledMember   Member? @relation("PreviousCancelledMember", fields: [previousCancelledMemberId], references: [id])
  reRegisteredMembers       Member[] @relation("PreviousCancelledMember") // Bu Ã¼yeden yeniden kayÄ±t olanlar

  // ðŸ”¹ Aidat planÄ± iliÅŸkisi
  duesPlanId String?
  duesPlan   DuesPlan? @relation(fields: [duesPlanId], references: [id])

  // Aidat Ã¶demeleri
  duesPayments DuesPayment[]

  isActive  Boolean   @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Province {
  id   String  @id @default(cuid())
  name String
  code String? @unique

  districts  District[]
  workplaces Workplace[]
  dealers    Dealer[]
  members    Member[]

  userScopes UserScope[]
}

model District {
  id         String   @id @default(cuid())
  name       String
  provinceId String
  province   Province @relation(fields: [provinceId], references: [id])

  workplaces Workplace[]
  dealers    Dealer[]
  members    Member[]

  userScopes UserScope[]
}

model Workplace {
  id      String  @id @default(cuid())
  name    String
  address String?

  provinceId String?
  districtId String?

  province Province? @relation(fields: [provinceId], references: [id])
  district District? @relation(fields: [districtId], references: [id])

  members Member[]

  userScopes UserScope[]
}

model Dealer {
  id      String  @id @default(cuid())
  name    String
  code    String?
  address String?

  provinceId String?
  districtId String?

  province Province? @relation(fields: [provinceId], references: [id])
  district District? @relation(fields: [districtId], references: [id])

  members Member[]

  userScopes UserScope[]
}

model UserScope {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  provinceId  String?
  districtId  String?
  workplaceId String?
  dealerId    String?

  province  Province?  @relation(fields: [provinceId], references: [id])
  district  District?  @relation(fields: [districtId], references: [id])
  workplace Workplace? @relation(fields: [workplaceId], references: [id])
  dealer    Dealer?    @relation(fields: [dealerId], references: [id])

  createdAt DateTime @default(now())
}

model DuesPlan {
  id          String     @id @default(cuid())
  name        String
  description String?
  amount      Decimal    @db.Decimal(10, 2)
  period      DuesPeriod @default(MONTHLY)
  isActive    Boolean    @default(true)
  deletedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payments DuesPayment[]

  members Member[]
}

model DuesPayment {
  id String @id @default(cuid())

  memberId String
  member   Member @relation(fields: [memberId], references: [id])

  planId String?
  plan   DuesPlan? @relation(fields: [planId], references: [id])

  amount Decimal
  paidAt DateTime @default(now())

  // Ä°steÄŸe baÄŸlÄ±: hangi ay/yÄ±l iÃ§in
  periodYear  Int?
  periodMonth Int?

  note            String?
  createdByUserId String?

  isActive  Boolean   @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Custom Role Management
model CustomRole {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  deletedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  permissions CustomRolePermission[]
  users       User[]                 @relation("UserCustomRoles")
}

model CustomRolePermission {
  id         String     @id @default(cuid())
  roleId     String
  role       CustomRole @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission String // Permission enum deÄŸeri

  createdAt DateTime @default(now())

  @@unique([roleId, permission])
  @@index([roleId])
}
