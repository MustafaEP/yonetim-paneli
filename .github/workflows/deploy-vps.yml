name: Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Manuel tetikleme iÃ§in

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_SSH_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_SSH_HOST }}
          VPS_USER: ${{ secrets.VPS_SSH_USER }}
          DEPLOY_PATH: ${{ secrets.VPS_DEPLOY_PATH || '/var/www/yonetim-paneli' }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << EOF
            set -e
            echo "ðŸš€ GitHub Actions deployment baÅŸlatÄ±lÄ±yor..."
            
            # Proje dizinine git
            cd "${{ secrets.VPS_DEPLOY_PATH || '/var/www/yonetim-paneli' }}"
            
            # Git'ten son deÄŸiÅŸiklikleri Ã§ek
            echo "ðŸ“¥ Git'ten gÃ¼ncellemeler Ã§ekiliyor..."
            git fetch origin
            CURRENT_BRANCH=\$(git branch --show-current || echo "main")
            if git show-ref --verify --quiet refs/heads/main; then
              git reset --hard origin/main
            elif git show-ref --verify --quiet refs/heads/master; then
              git reset --hard origin/master
            else
              git reset --hard origin/\${CURRENT_BRANCH}
            fi
            git clean -fd
            
            # deploy-vps.sh script'i varsa kullan, yoksa manuel deployment yap
            if [ -f "./deploy-vps.sh" ]; then
              echo "ðŸ“œ deploy-vps.sh script'i kullanÄ±lÄ±yor..."
              chmod +x ./deploy-vps.sh
              ./deploy-vps.sh
            else
              echo "ðŸ“œ Manuel deployment yapÄ±lÄ±yor..."
              
              # Docker container'larÄ± durdur (sadece backend ve frontend)
              echo "ðŸ›‘ Mevcut container'lar durduruluyor..."
              docker-compose stop backend frontend || true
              
              # Backend ve Frontend'i yeniden build et
              echo "ðŸ”¨ Backend ve Frontend yeniden build ediliyor..."
              docker-compose build --no-cache backend frontend
              
              # Container'larÄ± baÅŸlat (migration'lar otomatik Ã§alÄ±ÅŸacak)
              echo "â–¶ï¸  Container'lar baÅŸlatÄ±lÄ±yor..."
              docker-compose up -d backend frontend
              
              # KÄ±sa bir bekleme
              sleep 10
              
              # Container durumunu kontrol et
              echo "ðŸ“Š Container durumlarÄ±:"
              docker-compose ps
              
              # Backend loglarÄ±nÄ±n son 30 satÄ±rÄ±nÄ± gÃ¶ster
              echo "ðŸ“‹ Backend loglarÄ± (son 30 satÄ±r):"
              docker-compose logs --tail=30 backend || true
              
              # Frontend loglarÄ±nÄ±n son 30 satÄ±rÄ±nÄ± gÃ¶ster
              echo "ðŸ“‹ Frontend loglarÄ± (son 30 satÄ±r):"
              docker-compose logs --tail=30 frontend || true
              
              echo ""
              echo "âœ… Deployment tamamlandÄ±!"
              echo "ðŸ“Š TÃ¼m loglar iÃ§in: docker-compose logs -f"
            fi
          EOF